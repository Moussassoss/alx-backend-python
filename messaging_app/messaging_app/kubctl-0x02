#!/bin/bash

# kubctl-0x02 - Blue-Green Deployment Script

set -e

BLUE_DEPLOYMENT="messaging_app/blue_deployment.yaml"
GREEN_DEPLOYMENT="messaging_app/green_deployment.yaml"
SERVICE="messaging_app/kubeservice.yaml"

echo "=== Deploying Blue-Green Django App ==="

# Apply blue deployment (current version)
echo "ğŸš€ Deploying blue version..."
kubectl apply -f $BLUE_DEPLOYMENT

# Apply green deployment (new version)
echo "ğŸš€ Deploying green version..."
kubectl apply -f $GREEN_DEPLOYMENT

# Apply the service pointing to blue initially
echo "âš¡ Applying service..."
kubectl apply -f $SERVICE

# List all pods to verify both deployments
echo "ğŸ” Listing all pods..."
kubectl get pods

# Check logs of green deployment pods for errors
echo "ğŸ“¦ Checking logs for green deployment..."
GREEN_PODS=$(kubectl get pods -l app=messaging-app,version=green -o jsonpath='{.items[*].metadata.name}')
for pod in $GREEN_PODS; do
    echo "---- Logs for pod: $pod ----"
    kubectl logs $pod
    echo "-----------------------------"
done

echo "ğŸ‰ Blue-Green deployment completed successfully!"
